<html>

<head>
  <title>Lucid Lineage</title>


  <link rel="stylesheet" href="dd_styles.css">
    <link rel="stylesheet" href="lib/menu.css">

  <script src="lib/jquery.js"></script>
  <script src="lib/jquery-ui.js"></script>
  
  <link rel="stylesheet" href="lib/jquery_base.css">
	<link rel="stylesheet" href="lib/jquery_style.css">
  

  
  <script src="lib/touchpunch.js"></script>


  <script type="text/javascript" charset="utf-8" src="lib/d3.js"></script>

  <script type="text/javascript" src="lib/cola.js"></script>
  <script type="text/javascript" src="lib/thenBy.js"></script>

  <script type="text/javascript" src="bjs_types.js"></script>
  <script type="text/javascript" src="bjs_data_json.js"></script>
  <script type="text/javascript" src="bjs_mv.js"></script>
  <script type="text/javascript" src="bjs_misc.js"></script>

  <script type="text/javascript" src="bjs_viewutils.js"></script>

  <script type="text/javascript" src="bjs_bipartite.js"></script>
  <script type="text/javascript" src="bjs_lineage.js"></script>
  <script type="text/javascript" src="bjs_tree.js"></script>
  <script type="text/javascript" src="bjs_comatrix.js"></script>
  <script type="text/javascript" src="bjs_hive.js"></script>
  <script type="text/javascript" src="bjs_cola.js"></script>

  <script type="text/javascript" src="testdata.js"></script>


  <script>
    /*global d3*/
    /*global bjs*/
    /*global testdata*/

    //global selections
    var svg = {};
    var rawJson = {}; // the last json string we processed
    var bip = {}; //our reference to the current visualizer, which refers to its modelview(?)
    var w = {}; //the global world (filtered)
    var viewConf = {};
    var theFilter = new bjs.filter();
    var theSquash = new bjs.squash();
    
    function shSquash(){
      if ($('#squashpal').css('visibility') == 'hidden')
          $('#squashpal').css('visibility', 'visible');
        else
          $('#squashpal').css('visibility', 'hidden');
    }
    
    function shFilter(){
      if ($('#filterpal').css('visibility') == 'hidden')
          $('#filterpal').css('visibility', 'visible');
        else
          $('#filterpal').css('visibility', 'hidden');
    }
    
    function shData(){
      if ($('#datapal').css('visibility') == 'hidden')
          $('#datapal').css('visibility', 'visible');
        else
          $('#datapal').css('visibility', 'hidden');
    }
    
    function shObj(){
      if ($('#objpal').css('visibility') == 'hidden')
          $('#objpal').css('visibility', 'visible');
        else
          $('#objpal').css('visibility', 'hidden');
    }

    function shVis(){
      if ($('#vispal').css('visibility') == 'hidden')
          $('#vispal').css('visibility', 'visible');
        else
          $('#vispal').css('visibility', 'hidden');
    }
    
        
    function shBipart(){
        bip = new bjs.bp_view();
        clear();
        refresh();
    }
    
    function shHive(){
        bip = new bjs.hive_view();
        clear();
        refresh();
    }

  function shMatrix(){
        bip = new bjs.cm_view();
        clear();
        refresh();
    }
    
    function shFlow(){
        bip = new bjs.flow_view();
        clear();
        refresh();
    }
    
    function shCola(){
        bip = new bjs.cola_view();
        clear();
        refresh();
    }
    
    function shTree(){
        bip = new bjs.tree_view();
        clear();
        refresh();
    }


    function init() {

      $('.palette').draggable().resize();

      svg = d3.select("svg");

      bjs.hover = mouseOverHandler;

      viewConf["optimize"] = 0;
      viewConf["colorPlan"] = "cat";
      viewConf["renderSummary"] = false;
      viewConf["hilile"] = "nothing";



      d3.select("#kill_objpal").on("click", function(d) {
        $("#objpal").css('visibility', 'hidden')
      });
      d3.select("#kill_squashpal").on("click", function(d) {
        $("#squashpal").css('visibility', 'hidden')
      });
      d3.select("#kill_datapal").on("click", function(d) {
        $("#datapal").css('visibility', 'hidden')
      });
      d3.select("#kill_filterpal").on("click", function(d) {
        $("#filterpal").css('visibility', 'hidden')
      });
      d3.select("#kill_vispal").on("click", function(d) {
        $("#vispal").css('visibility', 'hidden')
      });

      d3.select("#input_json_btn").on("click", function(d) {
        rawJson = JSON.parse($("#input_json").val());
        refresh();
      });

      d3.select("#input_test_btn").on("click", function(d) {
        rawJson = testdata.raw;
        refresh();
      });


      d3.select("#ctrl_filter_btn").on("click", function(d) {

        var inc = $("#ctrl_inc").val().trim();
        var exc = $("#ctrl_exc").val().trim();
        var inc_rels = $("#ctrl_inc_left").val().trim();
        var exc_rels = $("#ctrl_exc_left").val().trim();
        var only_crit = $("#ctrl_only_crit")[0].checked;
        var grab_left = $("#ctrl_grab_left")[0].checked;
        var grab_right = $("#ctrl_grab_right")[0].checked;
        
        theFilter = new bjs.filter(inc, exc, inc_rels, exc_rels, only_crit, grab_left, grab_right);

        refresh();
      });

      d3.select("#ctrl_squash_btn").on("click", function(d) {

        var el_fields = $("#ctrl_el_fields").val().trim();
        var el_assets = $("#ctrl_el_assets").val().trim();
        var el_internal = $("#ctrl_el_internal")[0].checked;
        
        theSquash = new bjs.squash(el_fields, el_assets, el_internal);

        refresh();
      });

      d3.select("#ctrl_squash_clear_btn").on("click", function(d) {
        theSquash = new bjs.squash();

        refresh();
      });

      d3.select("#ctrl_filter_clear_btn").on("click", function(d) {
        theFilter = new bjs.filter();

        refresh();
      });

      d3.select("#ctrl_opt_1").on("click", function(d) {
        viewConf["optimize"] = 1;
        redraw();
      });

      d3.select("#ctrl_opt_0").on("click", function(d) {
        viewConf["optimize"] = 0;
        redraw();
      });

      d3.select("#ctrl_detail_summary").on("click", function(d) {
        viewConf["renderSummary"] = true;
        redraw();
      });

      d3.select("#ctrl_detail_nodes").on("click", function(d) {
        viewConf["renderSummary"] = false;
        redraw();
      });

      d3.select("#ctrl_color_pkg").on("click", function(d) {
        viewConf["colorPlan"] = "pkg";
        redraw();
      });

      d3.select("#ctrl_color_cat").on("click", function(d) {
        viewConf["colorPlan"] = "cat";
        redraw();
      });

      d3.select("#ctrl_hi_crit").on("click", function(d) {
        viewConf["hilite"] = "critical";
        redraw();
      });

      d3.select("#ctrl_hi_untraced").on("click", function(d) {
        viewConf["hilite"] = "untraced";
        redraw();
      });

      d3.select("#ctrl_hi_nothing").on("click", function(d) {
        viewConf["hilite"] = "nothing";
        redraw();
      });

      arrangePalettes();

      rawJson = testdata.raw;
      refresh();


    }

    function arrangePalettes() {
      $('#filterpal').css('visibility', 'visible');
      $('#squashpal').css('visibility', 'visible');
      $('#vispal').css('visibility', 'visible');
      $('#objpal').css('visibility', 'visible');
      $('#datapal').css('visibility', 'hidden');

      $("#filterpal").position({
        my: "right-20 top-20",
        at: "right bottom",
        of: "#menu",
        within: "#mycontent",
        collision: "fit"
      });
      $("#objpal").position({
        my: "right-5 top",
        at: "left top",
        of: "#filterpal",
        collision: "fit"
      });
      $("#squashpal").position({
        my: "left top+5",
        at: "left bottom",
        of: "#filterpal",
        collision: "fit"
      });
      $("#vispal").position({
       my: "left top+5",
        at: "left bottom",
        of: "#squashpal",
        collision: "fit"
      });
      $("#datapal").position({
        my: "left top+5",
        at: "left bottom",
        of: "#objpal",
        collision: "fit"
      });
    }


    function refresh() {
      w = bjs_data_json.fromJson(rawJson, theFilter, theSquash);
      updateDataSummary(w);
      redraw();
    }


    function redraw() {
      mouseOverHandler(null);
      bip.render(svg, w, viewConf);
    }

    function clear() {
      d3.selectAll("svg > *").remove();
    }


    $(document).ready(function() {
      bip = new bjs.bp_view();
      init();
    });

    function updateDataSummary(w) {

      var txt = "";

      var fields = 0,
        outs = 0,
        ins = 0,
        mids = 0,
        orphs = 0;

      for (var i in w.fields) {
        var f = w.fields[i];
        if (f.hasSources) {
          f.hasTargets ? mids++ : outs++;
        }
        else {
          f.hasTargets ? ins++ : orphs++;
        }
        fields++;
      }

      txt += fields + " fields.<br/>";
      txt += w.rels.length + " links.<br/><br/>";

      txt += "Output fields: " + outs + "<br/>";
      txt += "Input fields: " + ins + "<br/>";
      txt += "Intermediate fields: " + mids + "<br/>";
      txt += "Orphan fields: " + orphs + "<br/>";


      d3.select("#data_summary").html(txt);
    }

    function mouseOverHandler(d) {

      var name = "",
        summary = "",
        details = "";

      if (d != null) {


        if (d.itemtype == "node") {
          name = "Field " + d.field.name;

          summary += d.field.desc + "<br/>";
          summary += "Type: " + d.field.fieldtype + "<br/>";
          summary += "Found in dataset: " + d.field.asset.fullname + "<br/>";
          summary += "Criticality: " + d.field.critical + "<br/>";
          summary += (d.field.term == null)?"Not associated with a business term":"Term: " + d.field.term.name;

          details += "<h3>Content:</h3><ul><li>Description: " + d.field.desc + "</li><li>Formula: " + d.field.formula + "</li></ul>";

          details += "<h3>Risk Characteristics:</h3><ul><li>Risk: " + d.field.effrisk + "</li><li>Quality: " + d.field.effquality + "</li><li>Direct Risk: " + d.field.risk + "</li><li>Direct Quality: " + d.field.quality + "</li></ul>";

          if(d.field.term != null){
            details += "<h3>Business Term:</h3>Code: " + d.field.term.code + "<br/>Name: " + d.field.term.name + "<br/>Definition: " + d.field.term.desc;
          }else{
            details += "Not associated with a business term";
          }
        
        }

        if (d.itemtype == "group") {
          name = "Group " + d.fullname;

          summary += d.asset.desc + "<br/>";
          summary += "Type: " + d.asset.type + "<br/>";

          if(d.asset != null){

            details += "<h3>Content:</h3><ul><li>Description: " + d.asset.desc + "</li><li>Located At: " + bjs.breakPath(d.asset.location) +  + "</li><li>Calculated In: " + bjs.breakPath(d.asset.calc) + "</li></ul>";

            details += "<h3>Ownership:</h3><ul><li>Staff member: " + d.asset.owner + "</li><li>Team: " + d.asset.dept + "</li></ul>";

            details += "<h3>Risk Characteristics:</h3><ul><li>Direct Risk: " + d.asset.risk + "</li></ul>";

            details += "<h3>Timing Characteristics:</h3><ul><li>Available From:  Day " + d.asset.effnotbefore  + "</li><li>Inherent Latency: " + d.asset.latency + " Days </li><li>Theoretical Earliest: Day " + d.asset.notbefore + "</li></ul>";
            }
          
          else {
            summary = "Group is not based on a data asset";
            details = "n/a";
          }

        }
      } else {
        name = "<br/>";
        summary = "<br/><br/><br/>";
        details = "<br/>";
      }

      d3.select("#object_name").html(name);
      d3.select("#object_summary").html(summary);
      d3.select("#object_details").html(details);
    }
  </script>
</head>

<body>
  
    <nav id="menu-wrap">    
	<ul id="menu">
		<li id="menu-special"><img src="kinlogo2.png" style="margin-left: 10px;margin-right:10px;height:35px;"/> </li>
		
		<li>
			<a href="#">Windows</a>
			<ul>
				<li>
					<a href="#" onclick="shData();">Data Summary</a>
				</li>
				<li>
					<a href="#" onclick="shFilter();">Filter</a>
				</li>
				<li>
					<a href="#" onclick="shSquash();">Simplify</a>
				</li>
				<li>
					<a href="#" onclick="shObj();">Object Viewer</a>
				</li>
				<li>
					<a href="#" onclick="shVis();">Visualization</a>
				</li>
			</ul>
		</li>
		
		
		<li>
			<a href="#">Visualization</a>
			<ul>
				<li>
					<a href="#" onclick="shBipart();">Bipartite</a>
				</li>
				<li>
					<a href="#" onclick="shHive();">Hive</a>
				</li>
				<li>
					<a href="#" onclick="shFlow();">Flow</a>
				</li>
				<li>
					<a href="#" onclick="shCola();">Constrained</a>
				</li>
				<li>
					<a href="#" onclick="shMatrix();">Matrix</a>
				</li>
				<li>
					<a href="#" onclick="shTree();">Tree</a>
				</li>
			</ul>
		</li>
		
		<li>
			<a href="#">Reporting</a>
			<ul>
				<li>
					<a href="#" onclick="shBipart();">Export Images</a>
					<ul>
						<li>
							<a href="#" onclick="$('dialog_noconnection').dialog();">One per Hit</a>
							<a href="#" onclick="$('dialog_noconnection').dialog();">One Image</a>
						</li>
						</ul>
				</li>
				<li>
					<a href="#" onclick="shHive();">Metadata Health</a>
				</li>
				<li>
					<a href="#" onclick="shFlow();">Data Cost Metrics</a>
					<ul>
						<li>
							<a href="#" onclick="$('dialog_noconnection').dialog();">Analyse Metadata</a>
							<a href="#" onclick="$('dialog_noconnection').dialog();">Time Analysis</a>
						</li>
						</ul>
				</li>
			</ul>
		</li>
		
		
		<li>
			<a href="#">Import</a>
			<ul>
			  
			  	<li>
					<a href="#">Connect to SAS</a>
					<ul>
						<li>
							<a href="#" onclick="$('dialog_noconnection').dialog();">Connect base SAS</a>
							<a href="#" onclick="$('dialog_noconnection').dialog();">Connect DI</a>
						</li>
						</ul>
					</li>
					
					<li>
					<a href="#">Import Data Sets</a>
					<ul>
						<li>
						  <a href="#" onclick="$('dialog_nopermission').dialog();">Import Base</a>
							<a href="#" onclick="$('dialog_nopermission').dialog();">Import Excel</a>
							<a href="#" onclick="$('dialog_nopermission').dialog();">Import Json</a>
						</li>
						</ul>
					</li>
					
					<li>
					<a href="#">Manage Data Sets</a>
					<ul>
						<li>
							<a href="#" onclick="$('dialog_nopermission').dialog();">Data Set List</a>
							<a href="#" onclick="$('dialog_nopermission').dialog();">Refresh All</a>
						</li>
						</ul>
					</li>
					
					<li>
					<a href="#">Apply Values</a>
					<ul>
						<li>
							<a href="#" onclick="$('dialog_nopermission').dialog();">From SAS</a>
							<a href="#" onclick="$('dialog_nopermission').dialog();">From Json</a>
						</li>
						</ul>
					</li>
					
			</ul>
		</li>
		
		<li>
			<a href="#">Data</a>
			<ul>
				<li>
					<a href="#" onclick="">Edit Terms</a>
				</li>
				<li>
					<a href="#" onclick="">Edit Assets</a>
				</li>
				<li>
					<a href="#" onclick="">Edit Fields</a>
				</li>
				<li>
					<a href="#" onclick="">Edit Objects</a>
				</li>
				<li>
					<a href="#" onclick="">Edit Owners</a>
				</li>
				<li>
					<a href="#" onclick="">Asset Manager</a>
				</li>
			</ul>
		</li>
		
		<li>
			<a href="#">Favorites</a>
			<ul>
				<li>
					<a href="#" onclick="">Visualizations</a>
				</li>
				<li>
					<a href="#" onclick="">Filters</a>
				</li>
				<li>
					<a href="#" onclick="">Reports</a>
				</li>
			</ul>
		</li>
		
		
		<li>
			<a href="">Admin</a>
			<ul>
			<li>
					<a href="#" onclick="">Users</a>
				</li>
				<li>
					<a href="#" onclick="">Connections</a>
				</li>
				<li>
					<a href="#" onclick="">Console Window</a>
				</li>
		</li>
		<li><a href="">Help</a></li>
	</ul>
</nav>



  <div id="filterpal" class="palette">
    <div class="palheader">
      Filter
      <input type="submit" id="kill_filterpal" class="killbutton" value="" />
    </div>
    <div class="palbody">
      <table>
        <tr>
          <td>
            <label for="ctrl_inc">Include</label>
          </td>
          <td>
            <input type="text" name="ctrl_inc" id="ctrl_inc" value="" />
          </td>
        </tr>
        <tr>
          <td>
            <label for="ctrl_exc">Exclude</label>
          </td>
          <td>
            <input type="text" name="ctrl_exc" id="ctrl_exc" value="" />
          </td>
        </tr>
        <tr>
          <td>
            <label for="ctrl_inc_left">With relatives</label>
          </td>
          <td>
            <input type="text" name="ctrl_inc_left" id="ctrl_inc_left" value="" />
          </td>
        </tr>
        <tr>
          <td>
            <label for="ctrl_exc_left">Without relatives</label>
          </td>
          <td>
            <input type="text" name="ctrl_exc_left" id="ctrl_exc_left" value="" />
          </td>
        </tr>
        <tr>
          <td>
            <label for="ctrl_grab_left">Include ancestors</label>
          </td>
          <td>
            <input type="checkbox" name="ctrl_grab_left" id="ctrl_grab_left" value="grab_left" checked="true" />
          </td>
        </tr>
        <tr>
          <td>
            <label for="ctrl_grab_left">Include descendants</label>
          </td>
          <td>
            <input type="checkbox" name="ctrl_grab_right" id="ctrl_grab_right" value="grab_right" checked="true" />
          </td>
        </tr>
        <tr>
          <td>
            <label for="ctrl_only_crit">Critical Only</label>
          </td>
          <td>
            <input type="checkbox" name="ctrl_only_crit" id="ctrl_only_crit" value="only_crit" />
          </td>
        </tr>
        <tr>
          <td></td>
          <td>
            <input type="submit" name="ctrl_filter_btn" id="ctrl_filter_btn" value="Filter" />
            <input type="submit" name="ctrl_filter_btn" id="ctrl_filter_clear_btn" value="Clear" />
          </td>
        </tr>
      </table>
    </div>
  </div>

<div id="squashpal" class="palette">
    <div class="palheader">
      Simplify
      <input type="submit" id="kill_squashpal" class="killbutton" value="" />
    </div>
    <div class="palbody">
      <table>
        <tr>
          <td>
            <label for="ctrl_inc">Eliminate Fields</label>
          </td>
          <td>
            <input type="text" name="ctrl_el_fields" id="ctrl_el_fields" value="" />
          </td>
        </tr>
        <tr>
          <td>
            <label for="ctrl_exc">Eliminate Assets</label>
          </td>
          <td>
            <input type="text" name="ctrl_el_assets" id="ctrl_el_assets" value="" />
          </td>
        </tr>
        <tr>
          <td>
            <label for="ctrl_only_crit">Eliminate Internals</label>
          </td>
          <td>
            <input type="checkbox" name="ctrl_el_internal" id="ctrl_el_internal" value="el_internal" />
          </td>
        </tr>
        <tr>
          <td></td>
          <td>
            <input type="submit" name="ctrl_squash_btn" id="ctrl_squash_btn" value="Simplify" />
            <input type="submit" name="ctrl_squash_btn" id="ctrl_squash_clear_btn" value="Clear" />
          </td>
        </tr>
      </table>
    </div>
  </div>


  <div id="objpal" class="palette">
    <div class="palheader">
      Object Details
      <input type="submit" id="kill_objpal" class="killbutton" value="" />
    </div>
    <div class="palbody">
      <h2>Data item details</h2>
      <h3>Item name:</h3>
      <div id="object_name" class="info"></div>
      <h3>Summary:</h3>
      <div id="object_summary" class="info"></div>
      <h3>Details:</h3>
      <div id="object_details" class="info"></div>
    </div>

  </div>

  <div id="datapal" class="palette">
    <div class="palheader">
      Data Management
      <input type="submit" id="kill_datapal" class="killbutton" value="" />
    </div>
    <div class="palbody">
      <h3>Raw JSON input:</h3>
      <textarea id="input_json" height="300"></textarea>

      <input type="submit" id="input_json_btn" value="Load Json" />
      <hr/>
      <h3>Test dataset:</h3>
      <input type="submit" id="input_test_btn" value="Load Test Data" />
      <hr/>
      <h3>Stats:</h3>
      <div id="data_summary" class="info"></div>
    </div>
  </div>

  <div id="mycontent">
    <svg id="vis" viewbox="0 0 1600 1600" preserveAspectRatio="xMinyMin meet"></svg>
  </div>


  <div id="vispal" class="palette">
    <div class="palheader">
      Visualization Settings
      <input type="submit" id="kill_vispal" class="killbutton" value="" />
    </div>
    <div class="palbody">
      <table>
        <tr>
          <td colspan="2">
            <hr/>
          </td>
        </tr>
        <tr>
          <td>
            <label for="ctrl_grouping_dom">Optimize</label>
          </td>
          <td>
            <input type="radio" name="ctrl_opt" id="ctrl_opt_1" value="" />
          </td>
        </tr>
        <tr>
          <td>
            <label for="ctrl_grouping_dom">Don't Optimize</label>
          </td>
          <td>
            <input type="radio" name="ctrl_opt" id="ctrl_opt_0" value="" checked="true" />
          </td>
        </tr>
        <tr>
          <td colspan="2">
            <hr/>
          </td>
        </tr>
        <tr>
          <td>
            <label for="ctrl_grouping_dom">Dataset Level</label>
          </td>
          <td>
            <input type="radio" name="ctrl_detail" id="ctrl_detail_summary" value="" />
          </td>
        </tr>
        <tr>
          <td>
            <label for="ctrl_grouping_dom">Field Level</label>
          </td>
          <td>
            <input type="radio" name="ctrl_detail" id="ctrl_detail_nodes" value="" checked="true" />
          </td>
        </tr>
        <tr>
          <td colspan="2">
            <hr/>
          </td>
        </tr>
        <tr>
          <td>
            <label for="ctrl_grouping_dom">Color by Dataset Group</label>
          </td>
          <td>
            <input type="radio" name="ctrl_color" id="ctrl_color_cat" value="" checked="true" />
          </td>
        </tr>
        <tr>
          <td>
            <label for="ctrl_grouping_dom">Color by Dataset</label>
          </td>
          <td>
            <input type="radio" name="ctrl_color" id="ctrl_color_pkg" value="" />
          </td>
        </tr>
        <tr>
          <td colspan="2">
            <hr/>
          </td>
        </tr>
        <tr>
          <td>
            <label for="ctrl_grouping_dom">Hilight Critical fields</label>
          </td>
          <td>
            <input type="radio" name="ctrl_hilite" id="ctrl_hi_crit" value="" />
          </td>
        </tr>
        <tr>
          <td>
            <label for="ctrl_grouping_dom">Hilight Untraced fields</label>
          </td>
          <td>
            <input type="radio" name="ctrl_hilite" id="ctrl_hi_untraced" value="" />
          </td>
        </tr>
        <tr>
          <td>
            <label for="ctrl_grouping_dom">No hilight</label>
          </td>
          <td>
            <input type="radio" name="ctrl_hilite" id="ctrl_hi_nothing" value="" checked="true" />
          </td>
        </tr>
      </table>
    </div>
  </div>


  </div>
  
  


</body>

</html>
